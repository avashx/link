<!DOCTYPE html>
<html>
<head>
  <title>LinkedIn Profile View Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      min-height: 100vh; 
      color: #333; 
    }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    
    .header {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }
    
    .subtitle {
      color: #666;
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    
    .total-viewers {
      font-size: 3rem;
      font-weight: 800;
      color: #2c3e50;
      margin: 1rem 0;
    }
    
    .nav-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 1.5rem;
    }
    
    .btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 0.8rem 2rem;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn:active {
      transform: translateY(-1px);
    }
    
    .btn.secondary {
      background: linear-gradient(135deg, #f093fb, #f5576c);
      box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
    }
    
    .btn.secondary:hover {
      box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
    }
    
    .card {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    
    .card h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #2c3e50;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .calendar-header {
      text-align: center;
      font-weight: 600;
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 8px;
      font-size: 0.8rem;
      color: #666;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      font-size: 0.9rem;
    }
    
    .calendar-day:hover {
      background: #e9ecef;
      transform: scale(1.05);
    }
    
    .calendar-day.has-data {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    
    .calendar-day.today {
      border: 2px solid #f093fb;
      font-weight: 700;
    }
    
    .calendar-day .day-number {
      font-weight: 600;
      margin-bottom: 0.2rem;
    }
    
    .calendar-day .viewer-count {
      font-size: 0.7rem;
      opacity: 0.8;
    }
    
    .log { 
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 12px;
      padding: 1rem;
      max-height: 400px;
      overflow-y: auto;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    
    .log-entry {
      margin-bottom: 0.5rem;
      padding: 0.3rem 0.5rem;
      border-radius: 4px;
      border-left: 3px solid transparent;
    }
    
    .log-entry.info {
      border-left-color: #0ea5e9;
      background: rgba(14, 165, 233, 0.1);
    }
    
    .log-entry.error {
      border-left-color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }
    
    .log-entry.success {
      border-left-color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
    }
    
    .viewer { 
      background: #fff; 
      margin: 1rem 0; 
      padding: 1.5rem; 
      border-radius: 12px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      border-left: 4px solid #667eea;
    }
    
    .screenshot-img { 
      max-width:220px; 
      border-radius:12px; 
      box-shadow:0 4px 20px rgba(0,0,0,0.1); 
      cursor:pointer; 
      transition:transform 0.3s ease; 
    }
    
    .screenshot-img:hover { 
      transform: scale(1.05) translateY(-2px); 
    }
    
    #screenshot-popup {
      display:none; 
      position:fixed; 
      top:0; 
      left:0; 
      width:100vw; 
      height:100vh; 
      background:rgba(0,0,0,0.9); 
      z-index:9999;
      align-items:center; 
      justify-content:center;
      backdrop-filter: blur(5px);
    }
    
    #screenshot-popup img { 
      max-width:90vw; 
      max-height:90vh; 
      border-radius:16px; 
      box-shadow:0 8px 40px rgba(0,0,0,0.3); 
    }
    
    #screenshot-popup:active { display:none; }
    
    .status-bar {
      background: linear-gradient(90deg, #22c55e, #16a34a);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
      margin-bottom: 1rem;
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }
    
    @media (max-width: 768px) {
      .grid-2 { grid-template-columns: 1fr; }
      .nav-buttons { flex-direction: column; align-items: center; }
      .calendar-grid { grid-template-columns: repeat(7, 1fr); font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>LinkedIn Profile Tracker</h1>
      <div class="subtitle" id="last-updated">Loading...</div>
      <div class="total-viewers" id="total-viewers">0</div>
      <div class="status-bar" id="status">üîÑ Ready to track</div>
      
      <div class="nav-buttons">
        <button class="btn" onclick="launchScrape()">üöÄ Start Tracking</button>
        <button class="btn secondary" onclick="stopScrape()">‚èπ Stop Tracking</button>
        <button class="btn" onclick="fetchScreenshots()">üì∏ Refresh Screenshots</button>
        <button class="btn secondary" onclick="exportCSV()">üìä Export Data</button>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <h2>üìÖ Current Month Overview</h2>
        <div id="calendar-container">
          <div class="calendar-grid" id="calendar-grid">
            <!-- Calendar will be generated here -->
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üìä View Increases</h2>
        <div id="view-increases">Loading view increases...</div>
      </div>
    </div>

    <div class="card">
      <h2>üñ• Live System Logs</h2>
      <div class="log" id="logs">
        <div class="log-entry info">System initialized. Ready to track LinkedIn profile views...</div>
      </div>
    </div>

    <div class="card">
      <h2>üì∏ Recent Screenshots</h2>
      <div id="screenshot-table">Loading screenshots...</div>
    </div>

    <div class="card">
      <h2>üë• Recent Viewers</h2>
      <div id="viewer-table">Click "Start Tracking" to see recent viewers...</div>
    </div>
  </div>

  <div id="screenshot-popup" onclick="closeScreenshotPopup()">
    <img id="popup-img" src="" alt="Screenshot">
  </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1em;">
          <div style="background: #fff; padding: 1em; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Past 1 Hour</div>
            <div style="font-size: 1.5em; font-weight: bold; color: #4caf50;" id="increase-1h">+0</div>
          </div>
          <div style="background: #fff; padding: 1em; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Past 3 Hours</div>
            <div style="font-size: 1.5em; font-weight: bold; color: #2196f3;" id="increase-3h">+0</div>
          </div>
          <div style="background: #fff; padding: 1em; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Past 6 Hours</div>
            <div style="font-size: 1.5em; font-weight: bold; color: #ff9800;" id="increase-6h">+0</div>
          </div>
          <div style="background: #fff; padding: 1em; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Past 12 Hours</div>
            <div style="font-size: 1.5em; font-weight: bold; color: #e91e63;" id="increase-12h">+0</div>
          </div>
          <div style="background: #fff; padding: 1em; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Past 24 Hours</div>
            <div style="font-size: 1.5em; font-weight: bold; color: #9c27b0;" id="increase-24h">+0</div>
          </div>
        </div>
        <div id="last-update-time" style="text-align: center; margin-top: 1em; font-size: 0.9em; color: #888;"></div>
      </div>
    </section>
    <section style="margin-bottom: 3em;">
      <h3 style="font-size: 1.3em; font-weight: 600; margin-bottom: 1em; color:#222;">Recent Viewer Screenshots (OCR)</h3>
      <div id="screenshot-table" style="background:#fafafa; border-radius:12px; padding:1em;"></div>
    </section>
    <section style="margin-bottom: 3em;">
      <h3 style="font-size: 1.3em; font-weight: 600; margin-bottom: 1em; color:#222;">Viewer Details</h3>
      <div style="background:#fafafa; border-radius:12px; padding:2em;">
        <table style="width: 100%; border-collapse: collapse; background: #fff;">
          <thead style="background: #f6f6f6;">
            <tr>
              <th style="padding: 0.7em; text-align: left; color: #222;">Name</th>
              <th style="padding: 0.7em; text-align: left; color: #222;">Headline</th>
              <th style="padding: 0.7em; text-align: left; color: #222;">Company</th>
              <th style="padding: 0.7em; text-align: left; color: #222;">Timestamp</th>
            </tr>
          </thead>
          <tbody id="viewerTable"></tbody>
        </table>
      </div>
      <div style="margin-top:2em;">
        <canvas id="trendChart" style="width:100%; max-width:600px; height:80px;"></canvas>
      </div>
    </section>
    <section style="margin-top: 3em;">
      <h3 style="font-size: 1.3em; font-weight: 600; margin-bottom: 1em; color:#222;">Live Logs</h3>
      <div class="log" id="logs" style="background: #fff; color: #222; border-radius: 12px; padding: 1.5em; font-size: 1em; border:1px solid #eee;"></div>
    </section>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
// Import Firebase modules
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
import { getFirestore, collection, query, orderBy, limit, getDocs, where, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
import { getStorage, ref, getDownloadURL, listAll } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js';

// Backend API base URL: use localhost for dev, Render for prod
const BACKEND_URL = (location.hostname === 'localhost') ? 'http://localhost:3000' : 'https://link-q2qi.onrender.com';

const firebaseConfig = {
  apiKey: "AIzaSyAPX-69qLt2Kwc_6rjMzymUUXhtPwSxsHk",
  authDomain: "linkrtdb.firebaseapp.com",
  projectId: "linkrtdb",
  storageBucket: "linkrtdb.appspot.com",
  messagingSenderId: "250414480081",
  appId: "1:250414480081:web:79de7428b63923578063f0",
  measurementId: "G-EZ2XERVTK7"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// Fetch daily totals and show table
async function fetchDailyTotals() {
  try {
    const q = query(collection(db, "daily_totals"), orderBy("date", "desc"), limit(30));
    const snapshot = await getDocs(q);
    let html = '<h4 style="margin-bottom:1em;color:#222;">Daily Totals</h4><table style="width:100%;border-collapse:collapse;background:#fff;margin-top:1em;border-radius:8px;overflow:hidden;">';
    html += '<thead style="background:#f8f8f8;"><tr><th style="padding:0.8em;text-align:left;">Date</th><th style="padding:0.8em;text-align:left;">Total Viewers</th></tr></thead><tbody>';
    if (snapshot.empty) {
      html += '<tr><td colspan="2" style="padding:1em;text-align:center;color:#888;">No daily totals yet. Use Test DB to add sample data.</td></tr>';
    } else {
      snapshot.forEach(doc => {
        const d = doc.data();
        html += `<tr><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.date}</td><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.total}</td></tr>`;
      });
    }
    html += '</tbody></table>';
    document.getElementById('dailyTotalsTable').innerHTML = html;
  } catch (error) {
    console.error('Error fetching daily totals:', error);
    document.getElementById('dailyTotalsTable').innerHTML = '<p>Error loading daily totals.</p>';
  }
}

// Fetch screenshots from Firestore screenshots collection and show
async function fetchScreenshots() {
  try {
    const q = query(collection(db, "screenshots"), orderBy("uploadTime", "desc"), limit(20));
    const snapshot = await getDocs(q);
    let html = '<div style="display:flex;flex-wrap:wrap;gap:1em;">';
    
    if (snapshot.empty) {
      html += '<p style="color:#888;text-align:center;width:100%;padding:2em;">No screenshots available yet. Run the scraper to capture screenshots.</p>';
    } else {
      for (const doc of snapshot.docs) {
        const data = doc.data();
        let imageUrl = '';
        
        // Try Firebase Storage first, then fallback to local
        if (data.firebasePath && data.status === 'uploaded') {
          try {
            const storageRef = ref(storage, data.firebasePath);
            imageUrl = await getDownloadURL(storageRef);
          } catch (error) {
            console.log('Firebase Storage failed, using local path');
            imageUrl = data.localPath || `/screenshots/${data.filename}`;
          }
        } else {
          // Use local web-accessible path
          imageUrl = data.localPath || `/screenshots/${data.filename}`;
        }
        
        const displayTime = data.istTimestamp || data.timestamp || 'Unknown time';
        const viewers = data.totalViewers || 0;
        
        html += `<div style="text-align:center;">
          <img src="${imageUrl}" class="screenshot-img" onclick="openScreenshotPopup('${imageUrl}')" 
               style="max-width:220px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:0.5em;cursor:pointer;">
          <div style="color:#222;font-size:0.9em;margin-bottom:0.2em;">${displayTime}</div>
          <div style="color:#666;font-size:0.8em;">üë• ${viewers} viewers</div>
        </div>`;
      }
    }
    
    html += '</div>';
    document.getElementById('screenshot-table').innerHTML = html;
  } catch (error) {
    console.error('Error fetching screenshots:', error);
    document.getElementById('screenshot-table').innerHTML = '<p style="color:#f44;">Error loading screenshots: ' + error.message + '</p>';
  }
}

// Initialize on page load
window.onload = async () => {
  await fetchTotalViewers();
  await generateCalendar();
  await fetchViewIncreases();
  await fetchScreenshots();
  startLogRefresh();
};

// Fetch latest total viewers and last updated time
async function fetchTotalViewers() {
  try {
    const q = query(collection(db, "daily_totals"), orderBy("timestamp", "desc"), limit(1));
    const snapshot = await getDocs(q);
    
    let total = 0;
    let lastDate = '';
    
    if (!snapshot.empty) {
      const data = snapshot.docs[0].data();
      total = data.total || 0;
      
      // Format the timestamp to show last updated
      if (data.timestamp) {
        const date = data.timestamp.toDate();
        const options = { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric', 
          hour: 'numeric', 
          minute: 'numeric', 
          second: 'numeric',
          hour12: true 
        };
        lastDate = date.toLocaleDateString('en-US', options);
      } else {
        lastDate = data.date || 'Unknown';
      }
    }
    
    document.getElementById('total-viewers').textContent = total.toLocaleString();
    document.getElementById('last-updated').textContent = lastDate ? `Last updated: ${lastDate}` : 'No data available';
    
  } catch (error) {
    console.error('Error fetching total viewers:', error);
    document.getElementById('total-viewers').textContent = '0';
    document.getElementById('last-updated').textContent = 'Error loading data';
  }
}

// Generate calendar grid for current month
async function generateCalendar() {
  try {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay(); // 0 = Sunday
    
    // Fetch daily totals for this month
    const monthStart = `1/${month + 1}/${year}`;
    const monthEnd = `${daysInMonth}/${month + 1}/${year}`;
    
    const q = query(collection(db, "daily_totals"));
    const snapshot = await getDocs(q);
    
    const dailyData = {};
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.date && data.total) {
        dailyData[data.date] = data.total;
      }
    });
    
    // Generate calendar HTML
    const calendarGrid = document.getElementById('calendar-grid');
    let html = '';
    
    // Add day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
      html += `<div class="calendar-header">${day}</div>`;
    });
    
    // Add empty cells for days before month starts
    for (let i = 0; i < startDayOfWeek; i++) {
      html += '<div class="calendar-day"></div>';
    }
    
    // Add days of the month
    for (let day = 1; day <= daysInMonth; day++) {
      const dateKey = `${day}/${month + 1}/${year}`;
      const isToday = (day === now.getDate() && month === now.getMonth() && year === now.getFullYear());
      const hasData = dailyData[dateKey];
      
      let classes = 'calendar-day';
      if (isToday) classes += ' today';
      if (hasData) classes += ' has-data';
      
      html += `
        <div class="${classes}" onclick="selectCalendarDate('${dateKey}')">
          <div class="day-number">${day}</div>
          ${hasData ? `<div class="viewer-count">${hasData}</div>` : ''}
        </div>
      `;
    }
    
    calendarGrid.innerHTML = html;
    
  } catch (error) {
    console.error('Error generating calendar:', error);
    document.getElementById('calendar-grid').innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #f44;">Error loading calendar</div>';
  }
}

// Select a date from calendar
function selectCalendarDate(dateKey) {
  // Update total viewers display for selected date
  fetchTotalViewersByDate(dateKey);
}

// Fetch total viewers for specific date
async function fetchTotalViewersByDate(dateKey) {
  try {
    const q = query(collection(db, "daily_totals"), where("date", "==", dateKey), limit(1));
    const snapshot = await getDocs(q);
    
    if (!snapshot.empty) {
      const data = snapshot.docs[0].data();
      document.getElementById('total-viewers').textContent = data.total?.toLocaleString() || '0';
      document.getElementById('last-updated').textContent = `Selected date: ${dateKey} (${data.total || 0} viewers)`;
    } else {
      document.getElementById('total-viewers').textContent = '0';
      document.getElementById('last-updated').textContent = `No data for ${dateKey}`;
    }
  } catch (error) {
    console.error('Error fetching date data:', error);
  }
}

// Fetch total by selected date
async function fetchTotalByDate() {
  const selectedDate = document.getElementById('dateSelector').value;
  if (selectedDate) {
    // Convert YYYY-MM-DD to DD/MM/YYYY format for Firestore
    const [year, month, day] = selectedDate.split('-');
    const formattedDate = `${day}/${month}/${year}`;
    await fetchTotalViewers(formattedDate);
  }
}

// Calculate view increases for different time periods
async function fetchViewIncreases() {
  try {
    const now = new Date();
    const periods = [
      { id: 'increase-1h', hours: 1 },
      { id: 'increase-3h', hours: 3 },
      { id: 'increase-6h', hours: 6 },
      { id: 'increase-12h', hours: 12 },
      { id: 'increase-24h', hours: 24 }
    ];

    // Get current total
    const currentQ = query(collection(db, "daily_totals"), orderBy("timestamp", "desc"), limit(1));
    const currentSnapshot = await getDocs(currentQ);
    let currentTotal = 0;
    if (!currentSnapshot.empty) {
      currentSnapshot.forEach(doc => { currentTotal = doc.data().total; });
    }

    for (const period of periods) {
      try {
        const pastTime = new Date(now.getTime() - (period.hours * 60 * 60 * 1000));
        
        // Get the closest record to the past time
        const pastQ = query(
          collection(db, "daily_totals"), 
          where("timestamp", "<=", pastTime.toISOString()),
          orderBy("timestamp", "desc"), 
          limit(1)
        );
        const pastSnapshot = await getDocs(pastQ);
        
        let pastTotal = 0;
        if (!pastSnapshot.empty) {
          pastSnapshot.forEach(doc => { pastTotal = doc.data().total; });
        }
        
        const increase = Math.max(0, currentTotal - pastTotal);
        const element = document.getElementById(period.id);
        if (element) {
          element.textContent = `+${increase}`;
        }
      } catch (error) {
        console.error(`Error calculating ${period.hours}h increase:`, error);
        const element = document.getElementById(period.id);
        if (element) {
          element.textContent = '+0';
        }
      }
    }
    
    // Update last update time
    const lastUpdateElement = document.getElementById('last-update-time');
    if (lastUpdateElement) {
      lastUpdateElement.textContent = `Last updated: ${now.toLocaleString("en-IN", { timeZone: "Asia/Kolkata" })}`;
    }
  } catch (error) {
    console.error('Error fetching view increases:', error);
  }
}

// Fetch latest total (reset date selector)
async function fetchLatestTotal() {
  document.getElementById('dateSelector').value = '';
  await fetchTotalViewers();
}

// Fetch and display enhanced live logs
async function fetchLiveLogs() {
  try {
    const response = await fetch(`${BACKEND_URL}/api/logs`);
    const data = await response.json();
    const logsDiv = document.getElementById('logs');
    
    if (data.logs && data.logs.length > 0) {
      // Process logs with enhanced styling
      const logLines = data.logs.slice(-50).map(log => {
        let logClass = 'log-entry';
        let logContent = log;
        
        // Determine log type and apply styling
        if (log.includes('ERROR') || log.includes('‚ùå')) {
          logClass += ' error';
        } else if (log.includes('INFO') || log.includes('‚úÖ') || log.includes('üì∏') || log.includes('üìä')) {
          logClass += ' success';
        } else {
          logClass += ' info';
        }
        
        // Format timestamp if present
        logContent = logContent.replace(/\[(.*?)\]/, '<span style="color: #888; font-size: 0.8em;">[$1]</span>');
        
        return `<div class="${logClass}">${logContent}</div>`;
      }).join('');
      
      logsDiv.innerHTML = logLines;
      
      // Auto-scroll to bottom for latest logs
      logsDiv.scrollTop = logsDiv.scrollHeight;
    } else {
      logsDiv.innerHTML = '<div class="log-entry info">System ready. Click "Start Tracking" to begin monitoring LinkedIn profile views.</div>';
    }
  } catch (error) {
    console.error('Error fetching logs:', error);
    document.getElementById('logs').innerHTML = '<div class="log-entry error">‚ùå Error loading system logs. Check connection.</div>';
  }
}

// Start live log refresh
function startLogRefresh() {
  fetchLiveLogs(); // Initial fetch
  setInterval(fetchLiveLogs, 3000); // Refresh every 3 seconds
}

// Insert mock viewer data for testing Firestore connection
async function insertMockViewer() {
  const viewerCol = collection(db, "viewers");
  const mockViewer = {
    name: "Test User",
    headline: "Testing Headline",
    company: "Test Company",
    timestamp: new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" })
  };
  await addDoc(viewerCol, mockViewer);
}

// Fetch viewer details and show in table
async function fetchViewerDetails() {
  try {
    const q = query(collection(db, "viewers"), orderBy("timestamp", "desc"), limit(30));
    const snapshot = await getDocs(q);
    let html = "";
    if (snapshot.empty) {
      html = `<tr><td colspan="4" style="padding:1em;text-align:center;color:#888;">No viewer data yet. Use Test DB to add sample data or run the scraper.</td></tr>`;
    } else {
      snapshot.forEach(doc => {
        const d = doc.data();
        html += `<tr><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.name || 'N/A'}</td><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.headline || 'N/A'}</td><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.company || 'N/A'}</td><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.timestamp || 'N/A'}</td></tr>`;
      });
    }
    // Add test element row for visual confirmation
    html += `<tr style='background:#ffe;'><td style="padding:0.8em;border-bottom:1px solid #eee;">Test Element</td><td style="padding:0.8em;border-bottom:1px solid #eee;">Test Headline</td><td style="padding:0.8em;border-bottom:1px solid #eee;">Test Company</td><td style="padding:0.8em;border-bottom:1px solid #eee;">${new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" })}</td></tr>`;
    document.getElementById('viewerTable').innerHTML = html;
  } catch (error) {
    console.error('Error fetching viewer details:', error);
    document.getElementById('viewerTable').innerHTML = `<tr><td colspan="4" style="padding:1em;text-align:center;color:#f44;">Error loading viewer data: ${error.message}</td></tr>`;
  }
}

// Insert mock daily total for testing
async function insertMockDailyTotal() {
  try {
    const dailyCol = collection(db, "daily_totals");
    const today = new Date().toLocaleDateString("en-IN", { timeZone: "Asia/Kolkata" });
    const randomTotal = Math.floor(Math.random()*100)+1;
    await addDoc(dailyCol, { date: today, total: randomTotal });
    console.log('Mock daily total added successfully');
  } catch (error) {
    console.error('Error adding mock daily total:', error);
  }
}

// Insert mock viewer data for testing Firestore connection
async function insertMockViewer() {
  try {
    const viewerCol = collection(db, "viewers");
    const mockViewer = {
      name: "Test User " + Math.floor(Math.random()*1000),
      headline: "Testing Headline",
      company: "Test Company",
      timestamp: new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" })
    };
    await addDoc(viewerCol, mockViewer);
    console.log('Mock viewer added successfully');
  } catch (error) {
    console.error('Error adding mock viewer:', error);
  }
}

// Status bar logic (removed duplicate, only in global script)

// Removed duplicate window functions (moved to global scope)

// Fetch and display live logs
async function fetchLiveLogs() {
  try {
    const backendURL = (location.hostname === 'localhost') ? 'http://localhost:3000' : 'https://link-q2qi.onrender.com';
    const response = await fetch(`${backendURL}/api/logs`);
    const data = await response.json();
    const logsDiv = document.getElementById('logs');
    if (data.logs && data.logs.length > 0) {
      logsDiv.innerHTML = data.logs.slice(0, 20).join('<br>');
    } else {
      logsDiv.innerHTML = 'No logs yet. Click Launch!! to start scraping.';
    }
  } catch (error) {
    console.error('Error fetching logs:', error);
    document.getElementById('logs').innerHTML = 'Error loading logs.';
  }
}

// Auto-refresh logs every 2 seconds
let logInterval;
function startLogRefresh() {
  if (logInterval) clearInterval(logInterval);
  logInterval = setInterval(fetchLiveLogs, 2000);
}

function stopLogRefresh() {
  if (logInterval) {
    clearInterval(logInterval);
    logInterval = null;
  }
}

// Make functions globally accessible for button handlers
window.fetchTotalViewers = fetchTotalViewers;
window.fetchDailyTotals = fetchDailyTotals;
window.fetchScreenshots = fetchScreenshots;
window.fetchViewerDetails = fetchViewerDetails;
window.insertMockViewer = insertMockViewer;
window.insertMockDailyTotal = insertMockDailyTotal;
window.fetchLiveLogs = fetchLiveLogs;
window.startLogRefresh = startLogRefresh;
window.stopLogRefresh = stopLogRefresh;
window.fetchViewIncreases = fetchViewIncreases;
window.fetchTotalByDate = fetchTotalByDate;
window.fetchLatestTotal = fetchLatestTotal;
window.openScreenshotPopup = function(url) {
  document.getElementById('popup-img').src = url;
  document.getElementById('screenshot-popup').style.display = 'flex';
};

window.closeScreenshotPopup = function() {
  document.getElementById('screenshot-popup').style.display = 'none';
};

// TEST: Insert mock data to check Firestore connection
window.moduleTestFirestore = async function() {
  try {
    document.getElementById('status-bar').textContent = 'Testing DB...';
    document.getElementById('status-bar').style.background = '#ff9800';
    
    await insertMockViewer();
    await insertMockDailyTotal();
    
    // Refresh all data
    await fetchViewerDetails();
    await fetchTotalViewers();
    await fetchDailyTotals();
    await fetchScreenshots();
    await fetchViewIncreases();
    
    document.getElementById('status-bar').textContent = 'DB Test Complete';
    document.getElementById('status-bar').style.background = '#4caf50';
    
    setTimeout(() => {
      document.getElementById('status-bar').textContent = 'Idle';
      document.getElementById('status-bar').style.background = '#4f8cff';
    }, 3000);
  } catch (error) {
    console.error('Test failed:', error);
    document.getElementById('status-bar').textContent = 'DB Test Failed';
    document.getElementById('status-bar').style.background = '#ff4f4f';
  }
};

// Initial load
fetchTotalViewers();
fetchDailyTotals();
fetchScreenshots();
fetchViewerDetails();
fetchLiveLogs();
fetchViewIncreases();
startLogRefresh();

// Set up auto-refresh for view increases every 5 minutes
setInterval(fetchViewIncreases, 5 * 60 * 1000);
  </script>
  <script>
function setStatusBar(status) {
  const bar = document.getElementById('status-bar');
  bar.textContent = status;
  bar.style.background = status === 'Scraping...' ? '#ff9800' : (status === 'Stopped' ? '#ff4f4f' : '#4f8cff');
}

async function launchScrape() {
  document.getElementById('status').textContent = 'üöÄ Starting scraper...';
  document.getElementById('status').className = 'status-bar';
  
  try {
    const response = await fetch(`${BACKEND_URL}/api/scrape`, { method: 'POST' });
    const result = await response.json();
    
    document.getElementById('status').textContent = '‚úÖ Scraping completed';
    
    // Refresh all data after scraping
    await fetchTotalViewers();
    await generateCalendar();
    await fetchViewIncreases();
    await fetchScreenshots();
    
    // Reset status after 3 seconds
    setTimeout(() => {
      document.getElementById('status').textContent = 'üîÑ Ready to track';
    }, 3000);
    
  } catch (error) {
    console.error('Scraping error:', error);
    document.getElementById('status').textContent = '‚ùå Scraping failed';
    document.getElementById('status').style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
  }
}

async function stopScrape() {
  document.getElementById('status').textContent = '‚èπ Stopping...';
  
  try {
    const response = await fetch(`${BACKEND_URL}/api/stop`, { method: 'POST' });
    document.getElementById('status').textContent = '‚èπ Stopped';
    document.getElementById('status').style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
  } catch (error) {
    console.error('Stop error:', error);
    document.getElementById('status').textContent = '‚ùå Stop failed';
  }
}
// Export CSV function
async function exportCSV() {
  try {
    document.getElementById('status').textContent = 'üìä Exporting data...';
    const response = await fetch(`${BACKEND_URL}/api/export-csv`);
    
    if (response.ok) {
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `linkedin-viewers-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      document.getElementById('status').textContent = '‚úÖ CSV exported successfully';
      setTimeout(() => {
        document.getElementById('status').textContent = 'üîÑ Ready to track';
      }, 2000);
    }
  } catch (error) {
    console.error('Export error:', error);
    document.getElementById('status').textContent = '‚ùå Export failed';
  }
}

// Close screenshot popup
function closeScreenshotPopup() {
  document.getElementById('screenshot-popup').style.display = 'none';
}

// Open screenshot popup
function openScreenshotPopup(imageSrc) {
  document.getElementById('popup-img').src = imageSrc;
  document.getElementById('screenshot-popup').style.display = 'flex';
}

// Test Firestore connection
function handleTestFirestore() {
  if (window.moduleTestFirestore && typeof window.moduleTestFirestore === 'function') {
    window.moduleTestFirestore();
  } else {
    console.error('moduleTestFirestore function not available');
  }
}
  </script>
</body>
</html>