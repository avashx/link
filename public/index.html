<!DOCTYPE html>
<html>
<head>
  <title>LinkedIn Profile View Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: #f8fafc; 
      min-height: 100vh; 
      color: #1e293b;
      display: flex;
    }
    
    /* Sidebar Navigation */
    .sidebar {
      width: 280px;
      background: #ffffff;
      border-right: 1px solid #e2e8f0;
      padding: 2rem 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    
    .sidebar-header {
      padding: 0 2rem 2rem;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .sidebar-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .sidebar-header p {
      color: #64748b;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    
    .nav-menu {
      padding: 2rem 0;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 2rem;
      color: #64748b;
      text-decoration: none;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }
    
    .nav-item:hover, .nav-item.active {
      background: #f1f5f9;
      color: #0f172a;
      border-left-color: #3b82f6;
    }
    
    .nav-item .icon {
      width: 20px;
      height: 20px;
      font-size: 1.25rem;
    }
    
    /* Main Content */
    .main-content {
      margin-left: 280px;
      flex: 1;
      padding: 2rem;
    }
    
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      background: white;
      padding: 1rem 2rem;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .page-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: #0f172a;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .status-indicator {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
      background: #10b981;
      color: white;
    }
    
    /* Overview Cards */
    .overview-section {
      margin-bottom: 2rem;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #0f172a;
    }
    
    .view-all-btn {
      color: #64748b;
      text-decoration: none;
      font-size: 0.875rem;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }
    
    .view-all-btn:hover {
      background: #f1f5f9;
      color: #0f172a;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .stat-card.primary {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
    }
    
    .stat-card.secondary {
      border: 1px solid #e2e8f0;
    }
    
    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .stat-card.primary .stat-icon {
      background: rgba(255,255,255,0.2);
    }
    
    .stat-card.secondary .stat-icon {
      background: #f1f5f9;
      color: #3b82f6;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 0.5rem;
    }
    
    .stat-label {
      font-size: 0.875rem;
      opacity: 0.8;
      font-weight: 500;
    }
    
    .stat-card.primary .stat-label {
      color: rgba(255,255,255,0.9);
    }
    
    .stat-card.secondary .stat-label {
      color: #64748b;
    }
    
    /* Content Grid */
    .content-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .card-header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #0f172a;
    }
    
    .card-content {
      padding: 2rem;
    }
    
    /* Table Styles */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      text-align: left;
      padding: 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: #64748b;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .data-table td {
      padding: 1rem;
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.875rem;
    }
    
    .data-table tr:hover {
      background: #f8fafc;
    }
    
    /* Calendar Grid */
    .calendar-container {
      padding: 1rem;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .calendar-nav {
      display: flex;
      gap: 0.5rem;
    }
    
    .calendar-nav button {
      background: none;
      border: 1px solid #e2e8f0;
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      color: #64748b;
    }
    
    .calendar-nav button:hover {
      background: #f1f5f9;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }
    
    .calendar-day-header {
      text-align: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: #64748b;
      padding: 0.5rem;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .calendar-day:hover {
      background: #f1f5f9;
    }
    
    .calendar-day.has-data {
      background: #dbeafe;
      color: #1d4ed8;
      font-weight: 600;
    }
    
    .calendar-day.today {
      background: #3b82f6;
      color: white;
      font-weight: 600;
    }
    
    .viewer-count {
      font-size: 0.625rem;
      margin-top: 0.25rem;
      opacity: 0.8;
    }
    
    /* Control Panel */
    .control-panel {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .control-row {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .control-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
    }
    
    .control-input {
      padding: 0.5rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.875rem;
    }
    
    .control-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: #f1f5f9;
      color: #374151;
      border: 1px solid #d1d5db;
    }
    
    .btn-secondary:hover {
      background: #e2e8f0;
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    /* Logs */
    .logs-container {
      background: #1e293b;
      border-radius: 8px;
      padding: 1rem;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 0.75rem;
      line-height: 1.5;
    }
    
    .log-entry {
      margin-bottom: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }
    
    .log-entry.info {
      color: #60a5fa;
    }
    
    .log-entry.success {
      color: #34d399;
    }
    
    .log-entry.error {
      color: #f87171;
    }
    
    .log-entry.warning {
      color: #fbbf24;
    }
    
    /* Screenshot Gallery */
    .screenshot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    .screenshot-item {
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
      cursor: pointer;
    }
    
    .screenshot-item:hover {
      transform: translateY(-2px);
    }
    
    .screenshot-item img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }
    
    .screenshot-info {
      padding: 0.75rem;
      background: white;
    }
    
    .screenshot-date {
      font-size: 0.75rem;
      color: #64748b;
    }
    
    .screenshot-viewers {
      font-size: 0.875rem;
      font-weight: 600;
      color: #0f172a;
      margin-top: 0.25rem;
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .content-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }
    }
    
    /* Modal/Popup */
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .popup-overlay.active {
      display: flex;
    }
    
    .popup-image {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <!-- Sidebar Navigation -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h1>üçΩÔ∏è Dashboard</h1>
      <p>LinkedIn Profile Tracker</p>
    </div>
    
    <nav class="nav-menu">
      <a href="#" class="nav-item active">
        <span class="icon">üè†</span>
        <span>Overview</span>
      </a>
      <a href="#" class="nav-item">
        <span class="icon">üë•</span>
        <span>Viewers</span>
      </a>
      <a href="#" class="nav-item">
        <span class="icon">üìä</span>
        <span>Analytics</span>
      </a>
      <a href="#" class="nav-item">
        <span class="icon">üì∏</span>
        <span>Screenshots</span>
      </a>
      <a href="#" class="nav-item">
        <span class="icon">‚öôÔ∏è</span>
        <span>Settings</span>
      </a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Top Bar -->
    <div class="top-bar">
      <h1 class="page-title">Dashboard</h1>
      <div class="user-info">
        <div class="status-indicator" id="connection-status">üîÑ Connecting...</div>
        <span>Admin User</span>
      </div>
    </div>

    <!-- Manual Controls -->
    <div class="control-panel">
      <h3 style="margin-bottom: 1rem; color: #0f172a;">Scraping Controls</h3>
      <div class="control-row">
        <div class="control-group">
          <label class="control-label">Frequency (minutes)</label>
          <input type="number" class="control-input" id="scrape-frequency" value="30" min="1" max="1440">
        </div>
        <div class="control-group">
          <label class="control-label">Next Run Time</label>
          <input type="datetime-local" class="control-input" id="next-run-time">
        </div>
        <div class="control-group" style="flex-direction: row; align-items: end; gap: 0.5rem;">
          <button class="btn btn-primary" onclick="launchScrape()">
            üöÄ Start Tracking
          </button>
          <button class="btn btn-danger" onclick="stopScrape()">
            ‚èπ Stop Tracking
          </button>
          <button class="btn btn-secondary" onclick="updateSchedule()">
            ÔøΩ Update Schedule
          </button>
        </div>
      </div>
    </div>

    <!-- Overview Section -->
    <div class="overview-section">
      <div class="section-header">
        <h2 class="section-title">Overview</h2>
        <a href="#" class="view-all-btn">View All</a>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card primary">
          <div class="stat-icon">ÔøΩ</div>
          <div class="stat-value" id="total-viewers">0</div>
          <div class="stat-label">Total Viewers</div>
        </div>
        
        <div class="stat-card secondary">
          <div class="stat-icon">üìà</div>
          <div class="stat-value" id="daily-increase">+0</div>
          <div class="stat-label">Daily Increase</div>
        </div>
        
        <div class="stat-card secondary">
          <div class="stat-icon">üë•</div>
          <div class="stat-value" id="free-viewers">0</div>
          <div class="stat-label">Free Viewers</div>
        </div>
      </div>
    </div>

    <!-- Content Grid -->
    <div class="content-grid">
      <!-- Recent Viewers -->
      <div class="card">
        <div class="card-header">
          <div class="section-header">
            <h3 class="card-title">Recent Viewers</h3>
            <a href="#" class="view-all-btn">View All</a>
          </div>
        </div>
        <div class="card-content">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Total Team</th>
                <th>Status</th>
                <th>Remaining Team</th>
              </tr>
            </thead>
            <tbody id="recent-viewers-table">
              <tr>
                <td>Click "Start Tracking" to see viewers</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- View Calendar -->
      <div class="card">
        <div class="card-header">
          <div class="section-header">
            <h3 class="card-title">View Calendar</h3>
            <select class="view-all-btn" style="border: 1px solid #e2e8f0; background: white;">
              <option>Monthly</option>
              <option>Weekly</option>
            </select>
          </div>
        </div>
        <div class="card-content">
          <div class="calendar-container">
            <div class="calendar-header">
              <h4 id="current-month">July 2025</h4>
              <div class="calendar-nav">
                <button onclick="previousMonth()">‚Äπ</button>
                <button onclick="nextMonth()">‚Ä∫</button>
              </div>
            </div>
            <div class="calendar-grid" id="calendar-grid">
              <!-- Calendar will be generated here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Live System Logs -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">üñ• Live System Logs</h3>
      </div>
      <div class="card-content">
        <div class="logs-container" id="logs">
          <div class="log-entry info">System initializing...</div>
        </div>
      </div>
    </div>

    <!-- Screenshots Gallery -->
    <div class="card">
      <div class="card-header">
        <div class="section-header">
          <h3 class="card-title">üì∏ Recent Screenshots</h3>
          <button class="view-all-btn" onclick="fetchScreenshots()">Refresh</button>
        </div>
      </div>
      <div class="card-content">
        <div class="screenshot-grid" id="screenshot-gallery">
          Loading screenshots...
        </div>
      </div>
    </div>
  </div>

  <!-- Screenshot Popup -->
  <div class="popup-overlay" id="screenshot-popup" onclick="closeScreenshotPopup()">
    <img class="popup-image" id="popup-img" src="" alt="Screenshot">
  </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1em;">
          <div style="background: #fff; padding: 1em; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Past 1 Hour</div>
            <div style="font-size: 1.5em; font-weight: bold; color: #4caf50;" id="increase-1h">+0</div>
          </div>
          <div style="background: #fff; padding: 1em; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Past 3 Hours</div>
            <div style="font-size: 1.5em; font-weight: bold; color: #2196f3;" id="increase-3h">+0</div>
          </div>
          <div style="background: #fff; padding: 1em; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Past 6 Hours</div>
            <div style="font-size: 1.5em; font-weight: bold; color: #ff9800;" id="increase-6h">+0</div>
          </div>
          <div style="background: #fff; padding: 1em; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Past 12 Hours</div>
            <div style="font-size: 1.5em; font-weight: bold; color: #e91e63;" id="increase-12h">+0</div>
          </div>
          <div style="background: #fff; padding: 1em; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="font-size: 0.9em; color: #666; margin-bottom: 0.5em;">Past 24 Hours</div>
            <div style="font-size: 1.5em; font-weight: bold; color: #9c27b0;" id="increase-24h">+0</div>
          </div>
        </div>
        <div id="last-update-time" style="text-align: center; margin-top: 1em; font-size: 0.9em; color: #888;"></div>
      </div>
    </section>
    <section style="margin-bottom: 3em;">
      <h3 style="font-size: 1.3em; font-weight: 600; margin-bottom: 1em; color:#222;">Recent Viewer Screenshots (OCR)</h3>
      <div id="screenshot-table" style="background:#fafafa; border-radius:12px; padding:1em;"></div>
    </section>
    <section style="margin-bottom: 3em;">
      <h3 style="font-size: 1.3em; font-weight: 600; margin-bottom: 1em; color:#222;">Viewer Details</h3>
      <div style="background:#fafafa; border-radius:12px; padding:2em;">
        <table style="width: 100%; border-collapse: collapse; background: #fff;">
          <thead style="background: #f6f6f6;">
            <tr>
              <th style="padding: 0.7em; text-align: left; color: #222;">Name</th>
              <th style="padding: 0.7em; text-align: left; color: #222;">Headline</th>
              <th style="padding: 0.7em; text-align: left; color: #222;">Company</th>
              <th style="padding: 0.7em; text-align: left; color: #222;">Timestamp</th>
            </tr>
          </thead>
          <tbody id="viewerTable"></tbody>
        </table>
      </div>
      <div style="margin-top:2em;">
        <canvas id="trendChart" style="width:100%; max-width:600px; height:80px;"></canvas>
      </div>
    </section>
    <section style="margin-top: 3em;">
      <h3 style="font-size: 1.3em; font-weight: 600; margin-bottom: 1em; color:#222;">Live Logs</h3>
      <div class="log" id="logs" style="background: #fff; color: #222; border-radius: 12px; padding: 1.5em; font-size: 1em; border:1px solid #eee;"></div>
    </section>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
// Import Firebase modules
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
import { getFirestore, collection, query, orderBy, limit, getDocs, where, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
import { getStorage, ref, getDownloadURL, listAll } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js';

// Backend API base URL: use localhost for dev, Render for prod
const BACKEND_URL = (location.hostname === 'localhost') ? 'http://localhost:3000' : 'https://link-q2qi.onrender.com';

const firebaseConfig = {
  apiKey: "AIzaSyAPX-69qLt2Kwc_6rjMzymUUXhtPwSxsHk",
  authDomain: "linkrtdb.firebaseapp.com",
  projectId: "linkrtdb",
  storageBucket: "linkrtdb.appspot.com",
  messagingSenderId: "250414480081",
  appId: "1:250414480081:web:79de7428b63923578063f0",
  measurementId: "G-EZ2XERVTK7"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// Fetch daily totals and show table
async function fetchDailyTotals() {
  try {
    const q = query(collection(db, "daily_totals"), orderBy("date", "desc"), limit(30));
    const snapshot = await getDocs(q);
    let html = '<h4 style="margin-bottom:1em;color:#222;">Daily Totals</h4><table style="width:100%;border-collapse:collapse;background:#fff;margin-top:1em;border-radius:8px;overflow:hidden;">';
    html += '<thead style="background:#f8f8f8;"><tr><th style="padding:0.8em;text-align:left;">Date</th><th style="padding:0.8em;text-align:left;">Total Viewers</th></tr></thead><tbody>';
    if (snapshot.empty) {
      html += '<tr><td colspan="2" style="padding:1em;text-align:center;color:#888;">No daily totals yet. Use Test DB to add sample data.</td></tr>';
    } else {
      snapshot.forEach(doc => {
        const d = doc.data();
        html += `<tr><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.date}</td><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.total}</td></tr>`;
      });
    }
    html += '</tbody></table>';
    document.getElementById('dailyTotalsTable').innerHTML = html;
  } catch (error) {
    console.error('Error fetching daily totals:', error);
    document.getElementById('dailyTotalsTable').innerHTML = '<p>Error loading daily totals.</p>';
  }
}

// Fetch screenshots and display in grid
async function fetchScreenshots() {
  try {
    logMessage('info', 'üì∏ Fetching recent screenshots...');
    
    const q = query(collection(db, "screenshots"), orderBy("uploadTime", "desc"), limit(12));
    const snapshot = await getDocs(q);
    
    const gallery = document.getElementById('screenshot-gallery');
    
    if (snapshot.empty) {
      gallery.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #64748b; padding: 2rem;">No screenshots available yet. Run the scraper to capture screenshots.</div>';
      return;
    }
    
    let html = '';
    for (const doc of snapshot.docs) {
      const data = doc.data();
      let imageUrl = '';
      
      // Try Firebase Storage first, then fallback to local
      if (data.firebasePath && data.status === 'uploaded') {
        try {
          const storageRef = ref(storage, data.firebasePath);
          imageUrl = await getDownloadURL(storageRef);
        } catch (error) {
          imageUrl = data.localPath || `/screenshots/${data.filename}`;
        }
      } else {
        imageUrl = data.localPath || `/screenshots/${data.filename}`;
      }
      
      const displayTime = data.istTimestamp || data.timestamp || 'Unknown time';
      const viewers = data.totalViewers || 0;
      
      html += `
        <div class="screenshot-item" onclick="openScreenshotPopup('${imageUrl}')">
          <img src="${imageUrl}" alt="Screenshot" onerror="this.src='/api/placeholder/200/150'">
          <div class="screenshot-info">
            <div class="screenshot-date">${displayTime}</div>
            <div class="screenshot-viewers">üë• ${viewers.toLocaleString()} viewers</div>
          </div>
        </div>
      `;
    }
    
    gallery.innerHTML = html;
    logMessage('success', `‚úÖ Loaded ${snapshot.size} screenshots`);
    
  } catch (error) {
    logMessage('error', '‚ùå Error fetching screenshots: ' + error.message);
    document.getElementById('screenshot-gallery').innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #ef4444; padding: 2rem;">Error loading screenshots</div>';
  }
}

// Enhanced live logs with backend integration
async function fetchLiveLogs() {
  try {
    const response = await fetch(`${BACKEND_URL}/api/logs`);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.logs && data.logs.length > 0) {
      // Process recent logs from backend
      const recentLogs = data.logs.slice(-20);
      recentLogs.forEach(log => {
        // Determine log type from content
        let type = 'info';
        if (log.includes('ERROR') || log.includes('‚ùå')) {
          type = 'error';
        } else if (log.includes('‚úÖ') || log.includes('SUCCESS')) {
          type = 'success';
        } else if (log.includes('‚ö†Ô∏è') || log.includes('WARNING')) {
          type = 'warning';
        }
        
        // Add to logs if it's not already there
        const logsContainer = document.getElementById('logs');
        const existingLogs = Array.from(logsContainer.querySelectorAll('.log-entry')).map(el => el.textContent);
        
        if (!existingLogs.some(existing => existing.includes(log.replace(/\[.*?\]\s*/, '')))) {
          const timestamp = new Date().toLocaleTimeString();
          const logEntry = document.createElement('div');
          logEntry.className = `log-entry ${type}`;
          logEntry.innerHTML = log.includes('[') ? log : `[${timestamp}] ${log}`;
          
          logsContainer.appendChild(logEntry);
          logsContainer.scrollTop = logsContainer.scrollHeight;
        }
      });
    }
  } catch (error) {
    // Silently fail for live logs to avoid spam
    console.error('Live logs fetch failed:', error);
  }
}

// Start live log refresh
function startLogRefresh() {
  // Set default schedule on load
  setDefaultSchedule();
  
  // Fetch live logs every 5 seconds
  setInterval(fetchLiveLogs, 5000);
  
  // Initial fetch
  fetchLiveLogs();
}

// Export CSV function
async function exportCSV() {
  try {
    logMessage('info', 'üìä Exporting viewer data to CSV...');
    
    const response = await fetch(`${BACKEND_URL}/api/export-csv`);
    
    if (response.ok) {
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `linkedin-viewers-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      logMessage('success', '‚úÖ CSV exported successfully');
    } else {
      throw new Error(`Export failed: ${response.status}`);
    }
  } catch (error) {
    logMessage('error', '‚ùå Export failed: ' + error.message);
  }
}

// Screenshot popup functions
function openScreenshotPopup(imageSrc) {
  document.getElementById('popup-img').src = imageSrc;
  document.getElementById('screenshot-popup').classList.add('active');
}

function closeScreenshotPopup() {
  document.getElementById('screenshot-popup').classList.remove('active');
}

// Escape key to close popup
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeScreenshotPopup();
  }
});

// Initialize on page load with database connection
window.onload = async () => {
  await initializeApp();
};

// Initialize the application
async function initializeApp() {
  logMessage('info', 'üîÑ System initializing...');
  logMessage('info', 'üîå Connecting to database...');
  
  try {
    // Test database connection
    const testQuery = query(collection(db, "daily_totals"), limit(1));
    await getDocs(testQuery);
    
    logMessage('success', '‚úÖ Connected to database successfully');
    document.getElementById('connection-status').textContent = '‚úÖ Connected';
    document.getElementById('connection-status').style.background = '#10b981';
    
    // Initialize all components
    await fetchTotalViewers();
    await generateCalendar();
    await fetchRecentViewers();
    await fetchScreenshots();
    
    // Start live log refresh
    startLogRefresh();
    
    logMessage('success', 'üéâ System ready for LinkedIn profile tracking');
    
  } catch (error) {
    logMessage('error', '‚ùå Database connection failed: ' + error.message);
    document.getElementById('connection-status').textContent = '‚ùå Disconnected';
    document.getElementById('connection-status').style.background = '#ef4444';
  }
}

// Add log message to the logs container
function logMessage(type, message) {
  const logsContainer = document.getElementById('logs');
  const timestamp = new Date().toLocaleTimeString();
  const logEntry = document.createElement('div');
  logEntry.className = `log-entry ${type}`;
  logEntry.innerHTML = `[${timestamp}] ${message}`;
  
  logsContainer.appendChild(logEntry);
  logsContainer.scrollTop = logsContainer.scrollHeight;
  
  // Keep only last 50 log entries
  const entries = logsContainer.querySelectorAll('.log-entry');
  if (entries.length > 50) {
    entries[0].remove();
  }
}

// Fetch total viewers from database and update display
async function fetchTotalViewers() {
  try {
    logMessage('info', 'üìä Fetching total viewers from database...');
    
    const q = query(collection(db, "daily_totals"), orderBy("timestamp", "desc"), limit(1));
    const snapshot = await getDocs(q);
    
    let total = 0;
    let dailyIncrease = 0;
    
    if (!snapshot.empty) {
      const latestData = snapshot.docs[0].data();
      total = latestData.total || 0;
      
      // Get yesterday's data for comparison
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayDate = yesterday.toLocaleDateString("en-IN", { timeZone: "Asia/Kolkata" });
      
      const yesterdayQuery = query(
        collection(db, "daily_totals"), 
        where("date", "==", yesterdayDate),
        limit(1)
      );
      const yesterdaySnapshot = await getDocs(yesterdayQuery);
      
      if (!yesterdaySnapshot.empty) {
        const yesterdayTotal = yesterdaySnapshot.docs[0].data().total || 0;
        dailyIncrease = total - yesterdayTotal;
      }
      
      logMessage('success', `‚úÖ Total viewers updated: ${total.toLocaleString()}`);
    } else {
      logMessage('warning', '‚ö†Ô∏è No viewer data found in database');
    }
    
    // Update display
    document.getElementById('total-viewers').textContent = total.toLocaleString();
    document.getElementById('daily-increase').textContent = dailyIncrease >= 0 ? `+${dailyIncrease}` : dailyIncrease.toString();
    
    // Update daily increase color
    const dailyIncreaseEl = document.getElementById('daily-increase');
    if (dailyIncrease > 0) {
      dailyIncreaseEl.style.color = '#10b981';
    } else if (dailyIncrease < 0) {
      dailyIncreaseEl.style.color = '#ef4444';
    }
    
  } catch (error) {
    logMessage('error', '‚ùå Error fetching total viewers: ' + error.message);
    document.getElementById('total-viewers').textContent = '0';
  }
}

// Fetch recent viewers and populate table
async function fetchRecentViewers() {
  try {
    const q = query(collection(db, "viewers"), orderBy("timestamp", "desc"), limit(10));
    const snapshot = await getDocs(q);
    
    const tbody = document.getElementById('recent-viewers-table');
    tbody.innerHTML = '';
    
    if (snapshot.empty) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #64748b;">No recent viewers found</td></tr>';
      return;
    }
    
    let freeViewerCount = 0;
    snapshot.forEach(doc => {
      const data = doc.data();
      const row = document.createElement('tr');
      
      // Determine if it's a free viewer (has detailed info)
      const isFreeViewer = data.name && !data.name.includes('Someone at');
      if (isFreeViewer) freeViewerCount++;
      
      row.innerHTML = `
        <td>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <div style="width: 32px; height: 32px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              üë§
            </div>
            <div>
              <div style="font-weight: 500; font-size: 0.875rem;">${data.name || 'Anonymous'}</div>
              <div style="font-size: 0.75rem; color: #64748b;">${data.headline || 'No headline'}</div>
            </div>
          </div>
        </td>
        <td>${data.company || '-'}</td>
        <td>
          <span style="padding: 0.25rem 0.5rem; background: ${isFreeViewer ? '#dbeafe' : '#f3f4f6'}; color: ${isFreeViewer ? '#1d4ed8' : '#6b7280'}; border-radius: 12px; font-size: 0.75rem;">
            ${isFreeViewer ? 'Free' : 'Premium'}
          </span>
        </td>
        <td style="font-size: 0.75rem; color: #64748b;">${data.timestamp || '-'}</td>
      `;
      
      tbody.appendChild(row);
    });
    
    // Update free viewers count
    document.getElementById('free-viewers').textContent = freeViewerCount;
    
  } catch (error) {
    logMessage('error', '‚ùå Error fetching recent viewers: ' + error.message);
  }
}

// Generate calendar grid for current month
async function generateCalendar() {
  try {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay(); // 0 = Sunday
    
    // Fetch daily totals for this month
    const monthStart = `1/${month + 1}/${year}`;
    const monthEnd = `${daysInMonth}/${month + 1}/${year}`;
    
    const q = query(collection(db, "daily_totals"));
    const snapshot = await getDocs(q);
    
    const dailyData = {};
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.date && data.total) {
        dailyData[data.date] = data.total;
      }
    });
    
    // Generate calendar HTML
    const calendarGrid = document.getElementById('calendar-grid');
    let html = '';
    
    // Add day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
      html += `<div class="calendar-header">${day}</div>`;
    });
    
    // Add empty cells for days before month starts
    for (let i = 0; i < startDayOfWeek; i++) {
      html += '<div class="calendar-day"></div>';
    }
    
    // Add days of the month
    for (let day = 1; day <= daysInMonth; day++) {
      const dateKey = `${day}/${month + 1}/${year}`;
      const isToday = (day === now.getDate() && month === now.getMonth() && year === now.getFullYear());
      const hasData = dailyData[dateKey];
      
      let classes = 'calendar-day';
      if (isToday) classes += ' today';
      if (hasData) classes += ' has-data';
      
      html += `
        <div class="${classes}" onclick="selectCalendarDate('${dateKey}')">
          <div class="day-number">${day}</div>
          ${hasData ? `<div class="viewer-count">${hasData}</div>` : ''}
        </div>
      `;
    }
    
    calendarGrid.innerHTML = html;
    
  } catch (error) {
    console.error('Error generating calendar:', error);
    document.getElementById('calendar-grid').innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #f44;">Error loading calendar</div>';
  }
}

// Select a date from calendar
function selectCalendarDate(dateKey) {
  // Update total viewers display for selected date
  fetchTotalViewersByDate(dateKey);
}

// Fetch total viewers for specific date
async function fetchTotalViewersByDate(dateKey) {
  try {
    const q = query(collection(db, "daily_totals"), where("date", "==", dateKey), limit(1));
    const snapshot = await getDocs(q);
    
    if (!snapshot.empty) {
      const data = snapshot.docs[0].data();
      document.getElementById('total-viewers').textContent = data.total?.toLocaleString() || '0';
      document.getElementById('last-updated').textContent = `Selected date: ${dateKey} (${data.total || 0} viewers)`;
    } else {
      document.getElementById('total-viewers').textContent = '0';
      document.getElementById('last-updated').textContent = `No data for ${dateKey}`;
    }
  } catch (error) {
    console.error('Error fetching date data:', error);
  }
}

// Fetch total by selected date
async function fetchTotalByDate() {
  const selectedDate = document.getElementById('dateSelector').value;
  if (selectedDate) {
    // Convert YYYY-MM-DD to DD/MM/YYYY format for Firestore
    const [year, month, day] = selectedDate.split('-');
    const formattedDate = `${day}/${month}/${year}`;
    await fetchTotalViewers(formattedDate);
  }
}

// Calculate view increases for different time periods
async function fetchViewIncreases() {
  try {
    const now = new Date();
    const periods = [
      { id: 'increase-1h', hours: 1 },
      { id: 'increase-3h', hours: 3 },
      { id: 'increase-6h', hours: 6 },
      { id: 'increase-12h', hours: 12 },
      { id: 'increase-24h', hours: 24 }
    ];

    // Get current total
    const currentQ = query(collection(db, "daily_totals"), orderBy("timestamp", "desc"), limit(1));
    const currentSnapshot = await getDocs(currentQ);
    let currentTotal = 0;
    if (!currentSnapshot.empty) {
      currentSnapshot.forEach(doc => { currentTotal = doc.data().total; });
    }

    for (const period of periods) {
      try {
        const pastTime = new Date(now.getTime() - (period.hours * 60 * 60 * 1000));
        
        // Get the closest record to the past time
        const pastQ = query(
          collection(db, "daily_totals"), 
          where("timestamp", "<=", pastTime.toISOString()),
          orderBy("timestamp", "desc"), 
          limit(1)
        );
        const pastSnapshot = await getDocs(pastQ);
        
        let pastTotal = 0;
        if (!pastSnapshot.empty) {
          pastSnapshot.forEach(doc => { pastTotal = doc.data().total; });
        }
        
        const increase = Math.max(0, currentTotal - pastTotal);
        const element = document.getElementById(period.id);
        if (element) {
          element.textContent = `+${increase}`;
        }
      } catch (error) {
        console.error(`Error calculating ${period.hours}h increase:`, error);
        const element = document.getElementById(period.id);
        if (element) {
          element.textContent = '+0';
        }
      }
    }
    
    // Update last update time
    const lastUpdateElement = document.getElementById('last-update-time');
    if (lastUpdateElement) {
      lastUpdateElement.textContent = `Last updated: ${now.toLocaleString("en-IN", { timeZone: "Asia/Kolkata" })}`;
    }
  } catch (error) {
    console.error('Error fetching view increases:', error);
  }
}

// Fetch latest total (reset date selector)
async function fetchLatestTotal() {
  document.getElementById('dateSelector').value = '';
  await fetchTotalViewers();
}

// Fetch and display enhanced live logs
async function fetchLiveLogs() {
  try {
    const response = await fetch(`${BACKEND_URL}/api/logs`);
    const data = await response.json();
    const logsDiv = document.getElementById('logs');
    
    if (data.logs && data.logs.length > 0) {
      // Process logs with enhanced styling
      const logLines = data.logs.slice(-50).map(log => {
        let logClass = 'log-entry';
        let logContent = log;
        
        // Determine log type and apply styling
        if (log.includes('ERROR') || log.includes('‚ùå')) {
          logClass += ' error';
        } else if (log.includes('INFO') || log.includes('‚úÖ') || log.includes('üì∏') || log.includes('üìä')) {
          logClass += ' success';
        } else {
          logClass += ' info';
        }
        
        // Format timestamp if present
        logContent = logContent.replace(/\[(.*?)\]/, '<span style="color: #888; font-size: 0.8em;">[$1]</span>');
        
        return `<div class="${logClass}">${logContent}</div>`;
      }).join('');
      
      logsDiv.innerHTML = logLines;
      
      // Auto-scroll to bottom for latest logs
      logsDiv.scrollTop = logsDiv.scrollHeight;
    } else {
      logsDiv.innerHTML = '<div class="log-entry info">System ready. Click "Start Tracking" to begin monitoring LinkedIn profile views.</div>';
    }
  } catch (error) {
    console.error('Error fetching logs:', error);
    document.getElementById('logs').innerHTML = '<div class="log-entry error">‚ùå Error loading system logs. Check connection.</div>';
  }
}

// Start live log refresh
function startLogRefresh() {
  fetchLiveLogs(); // Initial fetch
  setInterval(fetchLiveLogs, 3000); // Refresh every 3 seconds
}

// Insert mock viewer data for testing Firestore connection
async function insertMockViewer() {
  const viewerCol = collection(db, "viewers");
  const mockViewer = {
    name: "Test User",
    headline: "Testing Headline",
    company: "Test Company",
    timestamp: new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" })
  };
  await addDoc(viewerCol, mockViewer);
}

// Fetch viewer details and show in table
async function fetchViewerDetails() {
  try {
    const q = query(collection(db, "viewers"), orderBy("timestamp", "desc"), limit(30));
    const snapshot = await getDocs(q);
    let html = "";
    if (snapshot.empty) {
      html = `<tr><td colspan="4" style="padding:1em;text-align:center;color:#888;">No viewer data yet. Use Test DB to add sample data or run the scraper.</td></tr>`;
    } else {
      snapshot.forEach(doc => {
        const d = doc.data();
        html += `<tr><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.name || 'N/A'}</td><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.headline || 'N/A'}</td><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.company || 'N/A'}</td><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.timestamp || 'N/A'}</td></tr>`;
      });
    }
    // Add test element row for visual confirmation
    html += `<tr style='background:#ffe;'><td style="padding:0.8em;border-bottom:1px solid #eee;">Test Element</td><td style="padding:0.8em;border-bottom:1px solid #eee;">Test Headline</td><td style="padding:0.8em;border-bottom:1px solid #eee;">Test Company</td><td style="padding:0.8em;border-bottom:1px solid #eee;">${new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" })}</td></tr>`;
    document.getElementById('viewerTable').innerHTML = html;
  } catch (error) {
    console.error('Error fetching viewer details:', error);
    document.getElementById('viewerTable').innerHTML = `<tr><td colspan="4" style="padding:1em;text-align:center;color:#f44;">Error loading viewer data: ${error.message}</td></tr>`;
  }
}

// Insert mock daily total for testing
async function insertMockDailyTotal() {
  try {
    const dailyCol = collection(db, "daily_totals");
    const today = new Date().toLocaleDateString("en-IN", { timeZone: "Asia/Kolkata" });
    const randomTotal = Math.floor(Math.random()*100)+1;
    await addDoc(dailyCol, { date: today, total: randomTotal });
    console.log('Mock daily total added successfully');
  } catch (error) {
    console.error('Error adding mock daily total:', error);
  }
}

// Insert mock viewer data for testing Firestore connection
async function insertMockViewer() {
  try {
    const viewerCol = collection(db, "viewers");
    const mockViewer = {
      name: "Test User " + Math.floor(Math.random()*1000),
      headline: "Testing Headline",
      company: "Test Company",
      timestamp: new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" })
    };
    await addDoc(viewerCol, mockViewer);
    console.log('Mock viewer added successfully');
  } catch (error) {
    console.error('Error adding mock viewer:', error);
  }
}

// Status bar logic (removed duplicate, only in global script)

// Removed duplicate window functions (moved to global scope)

// Fetch and display live logs
async function fetchLiveLogs() {
  try {
    const backendURL = (location.hostname === 'localhost') ? 'http://localhost:3000' : 'https://link-q2qi.onrender.com';
    const response = await fetch(`${backendURL}/api/logs`);
    const data = await response.json();
    const logsDiv = document.getElementById('logs');
    if (data.logs && data.logs.length > 0) {
      logsDiv.innerHTML = data.logs.slice(0, 20).join('<br>');
    } else {
      logsDiv.innerHTML = 'No logs yet. Click Launch!! to start scraping.';
    }
  } catch (error) {
    console.error('Error fetching logs:', error);
    document.getElementById('logs').innerHTML = 'Error loading logs.';
  }
}

// Auto-refresh logs every 2 seconds
let logInterval;
function startLogRefresh() {
  if (logInterval) clearInterval(logInterval);
  logInterval = setInterval(fetchLiveLogs, 2000);
}

function stopLogRefresh() {
  if (logInterval) {
    clearInterval(logInterval);
    logInterval = null;
  }
}

// Make functions globally accessible for button handlers
window.fetchTotalViewers = fetchTotalViewers;
window.fetchDailyTotals = fetchDailyTotals;
window.fetchScreenshots = fetchScreenshots;
window.fetchViewerDetails = fetchViewerDetails;
window.insertMockViewer = insertMockViewer;
window.insertMockDailyTotal = insertMockDailyTotal;
window.fetchLiveLogs = fetchLiveLogs;
window.startLogRefresh = startLogRefresh;
window.stopLogRefresh = stopLogRefresh;
window.fetchViewIncreases = fetchViewIncreases;
window.fetchTotalByDate = fetchTotalByDate;
window.fetchLatestTotal = fetchLatestTotal;
window.openScreenshotPopup = function(url) {
  document.getElementById('popup-img').src = url;
  document.getElementById('screenshot-popup').style.display = 'flex';
};

window.closeScreenshotPopup = function() {
  document.getElementById('screenshot-popup').style.display = 'none';
};

// TEST: Insert mock data to check Firestore connection
window.moduleTestFirestore = async function() {
  try {
    document.getElementById('status-bar').textContent = 'Testing DB...';
    document.getElementById('status-bar').style.background = '#ff9800';
    
    await insertMockViewer();
    await insertMockDailyTotal();
    
    // Refresh all data
    await fetchViewerDetails();
    await fetchTotalViewers();
    await fetchDailyTotals();
    await fetchScreenshots();
    await fetchViewIncreases();
    
    document.getElementById('status-bar').textContent = 'DB Test Complete';
    document.getElementById('status-bar').style.background = '#4caf50';
    
    setTimeout(() => {
      document.getElementById('status-bar').textContent = 'Idle';
      document.getElementById('status-bar').style.background = '#4f8cff';
    }, 3000);
  } catch (error) {
    console.error('Test failed:', error);
    document.getElementById('status-bar').textContent = 'DB Test Failed';
    document.getElementById('status-bar').style.background = '#ff4f4f';
  }
};

// Initial load
fetchTotalViewers();
fetchDailyTotals();
fetchScreenshots();
fetchViewerDetails();
fetchLiveLogs();
fetchViewIncreases();
startLogRefresh();

// Set up auto-refresh for view increases every 5 minutes
setInterval(fetchViewIncreases, 5 * 60 * 1000);
  </script>
  <script>
function setStatusBar(status) {
  const bar = document.getElementById('status-bar');
  bar.textContent = status;
  bar.style.background = status === 'Scraping...' ? '#ff9800' : (status === 'Stopped' ? '#ff4f4f' : '#4f8cff');
}

// Launch scraper with enhanced logging
async function launchScrape() {
  logMessage('info', 'üöÄ Starting LinkedIn profile scraper...');
  
  try {
    const response = await fetch(`${BACKEND_URL}/api/scrape`, { 
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    logMessage('success', `‚úÖ Scraping completed successfully`);
    logMessage('info', `üìä Total viewers found: ${result.totalViewers || 'N/A'}`);
    logMessage('info', `üë• Free viewers found: ${result.freeViewers?.length || 0}`);
    
    // Refresh all data after scraping
    await fetchTotalViewers();
    await generateCalendar();
    await fetchRecentViewers();
    await fetchScreenshots();
    
  } catch (error) {
    logMessage('error', `‚ùå Scraping failed: ${error.message}`);
    console.error('Scraping error:', error);
  }
}

// Stop scraper with proper API call
async function stopScrape() {
  logMessage('info', '‚èπ Stopping scraper...');
  
  try {
    const response = await fetch(`${BACKEND_URL}/api/stop-scraper`, { 
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      // Try alternative endpoint
      const altResponse = await fetch(`${BACKEND_URL}/api/stop`, { 
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      if (!altResponse.ok) {
        throw new Error(`Stop request failed: ${response.status}`);
      }
    }
    
    logMessage('success', '‚úÖ Scraper stopped successfully');
    
  } catch (error) {
    logMessage('error', `‚ùå Failed to stop scraper: ${error.message}`);
    console.error('Stop error:', error);
  }
}

// Update scraping schedule
function updateSchedule() {
  const frequency = document.getElementById('scrape-frequency').value;
  const nextRunTime = document.getElementById('next-run-time').value;
  
  if (!frequency || !nextRunTime) {
    logMessage('warning', '‚ö†Ô∏è Please set both frequency and next run time');
    return;
  }
  
  logMessage('info', `üìÖ Schedule updated: Every ${frequency} minutes, next run at ${new Date(nextRunTime).toLocaleString()}`);
  
  // Here you could implement actual scheduling logic
  // For now, just log the update
}

// Set default next run time to current time + 30 minutes
function setDefaultSchedule() {
  const now = new Date();
  now.setMinutes(now.getMinutes() + 30);
  const formatted = now.toISOString().slice(0, 16); // Format for datetime-local input
  document.getElementById('next-run-time').value = formatted;
}

// Enhanced calendar generation
async function generateCalendar() {
  try {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    
    // Update month display
    const monthNames = ["January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"];
    document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;
    
    // Get calendar data
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay();
    
    // Fetch daily totals for this month
    const q = query(collection(db, "daily_totals"));
    const snapshot = await getDocs(q);
    
    const dailyData = {};
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.date && data.total) {
        dailyData[data.date] = data.total;
      }
    });
    
    // Generate calendar HTML
    const calendarGrid = document.getElementById('calendar-grid');
    let html = '';
    
    // Add day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
      html += `<div class="calendar-day-header">${day}</div>`;
    });
    
    // Add empty cells for days before month starts
    for (let i = 0; i < startDayOfWeek; i++) {
      html += '<div class="calendar-day"></div>';
    }
    
    // Add days of the month
    for (let day = 1; day <= daysInMonth; day++) {
      const dateKey = `${day}/${month + 1}/${year}`;
      const isToday = (day === now.getDate() && month === now.getMonth() && year === now.getFullYear());
      const hasData = dailyData[dateKey];
      
      let classes = 'calendar-day';
      if (isToday) classes += ' today';
      if (hasData) classes += ' has-data';
      
      html += `
        <div class="${classes}" onclick="selectCalendarDate('${dateKey}', ${hasData || 0})">
          <div>${day}</div>
          ${hasData ? `<div class="viewer-count">${hasData}</div>` : ''}
        </div>
      `;
    }
    
    calendarGrid.innerHTML = html;
    
  } catch (error) {
    logMessage('error', '‚ùå Error generating calendar: ' + error.message);
  }
}

// Select calendar date
function selectCalendarDate(dateKey, viewers) {
  logMessage('info', `üìÖ Selected ${dateKey}: ${viewers} viewers`);
  // You could show more details about the selected date here
}

// Calendar navigation
let currentCalendarDate = new Date();

function previousMonth() {
  currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
  generateCalendar();
}

function nextMonth() {
  currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
  generateCalendar();
}
// Export CSV function
async function exportCSV() {
  try {
    document.getElementById('status').textContent = 'üìä Exporting data...';
    const response = await fetch(`${BACKEND_URL}/api/export-csv`);
    
    if (response.ok) {
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `linkedin-viewers-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      document.getElementById('status').textContent = '‚úÖ CSV exported successfully';
      setTimeout(() => {
        document.getElementById('status').textContent = 'üîÑ Ready to track';
      }, 2000);
    }
  } catch (error) {
    console.error('Export error:', error);
    document.getElementById('status').textContent = '‚ùå Export failed';
  }
}

// Close screenshot popup
function closeScreenshotPopup() {
  document.getElementById('screenshot-popup').style.display = 'none';
}

// Open screenshot popup
function openScreenshotPopup(imageSrc) {
  document.getElementById('popup-img').src = imageSrc;
  document.getElementById('screenshot-popup').style.display = 'flex';
}

// Test Firestore connection
function handleTestFirestore() {
  if (window.moduleTestFirestore && typeof window.moduleTestFirestore === 'function') {
    window.moduleTestFirestore();
  } else {
    console.error('moduleTestFirestore function not available');
  }
}
  </script>
</body>
</html>