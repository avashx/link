<!DOCTYPE html>
<html>
<head>
  <title>LinkedIn Profile View Tracker</title>
  <style>
    body { font-family: sans-serif; background: #f6f6f6; margin: 0; padding: 2em; }
    .btn { background: #333; color: #fff; padding: 1em 2em; border: none; border-radius: 5px; cursor: pointer; }
    .log { font-family: monospace; margin-top: 2em; }
    .viewer { background: #fff; margin: 1em 0; padding: 1em; border-radius: 5px; }
    .screenshot-img { max-width:220px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08); cursor:pointer; transition:transform 0.2s; }
    .screenshot-img:hover { transform:scale(1.05); }
    #screenshot-popup {
      display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.8); z-index:9999;
      align-items:center; justify-content:center;
    }
    #screenshot-popup img { max-width:90vw; max-height:90vh; border-radius:16px; box-shadow:0 4px 32px rgba(0,0,0,0.2); }
    #screenshot-popup:active { display:none; }
  </style>
</head>
<body>
  <nav style="background: #fff; color: #222; padding: 1.5em 2em; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee;">
    <div style="font-size: 2em; font-weight: bold; letter-spacing: 1px;">Profile Analytics</div>
    <div id="status-bar" style="font-size:1.2em;color:#fff;background:#4f8cff;padding:0.5em 1.5em;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-right:2em;">Idle</div>
    <button class="btn" id="launchBtn" onclick="launchScrape()" style="background:#222;color:#fff;">Launch!!</button>
    <button class="btn" onclick="stopScrape()" style="background:#ff4f4f;color:#fff;margin-left:1em;">Stop</button>
    <button class="btn" onclick="testFirestore()" style="background:#4caf50;color:#fff;margin-left:1em;">Test DB</button>
  </nav>
  <div id="screenshot-popup" onclick="closeScreenshotPopup()"><img id="popup-img" src="" alt="Screenshot"></div>
  <main style="max-width: 1200px; margin: 3em auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 32px rgba(0,0,0,0.07); padding: 3em;">
    <section style="margin-bottom: 3em; display: flex; gap: 4em; justify-content: space-between;">
      <div style="flex:1;">
        <h2 style="font-size: 2em; font-weight: 700; margin-bottom: 1em; color:#222;">Total Viewers</h2>
        <div style="font-size: 3em; font-weight: bold; color: #222; background: #f8f8f8; border-radius: 12px; padding: 1em 2em; display:inline-block;"> <span id="total">0</span></div>
        <div id="last-updated" style="font-size:1em;color:#888;margin-top:0.5em;"></div>
      </div>
      <div style="flex:2;">
        <div id="dailyTotalsTable" style="margin-top:1em;"></div>
      </div>
    </section>
    <section style="margin-bottom: 3em;">
      <h3 style="font-size: 1.3em; font-weight: 600; margin-bottom: 1em; color:#222;">Recent Viewer Screenshots (OCR)</h3>
      <div id="screenshot-table" style="background:#fafafa; border-radius:12px; padding:1em;"></div>
    </section>
    <section style="margin-bottom: 3em;">
      <h3 style="font-size: 1.3em; font-weight: 600; margin-bottom: 1em; color:#222;">Viewer Details</h3>
      <div style="background:#fafafa; border-radius:12px; padding:2em;">
        <table style="width: 100%; border-collapse: collapse; background: #fff;">
          <thead style="background: #f6f6f6;">
            <tr>
              <th style="padding: 0.7em; text-align: left; color: #222;">Name</th>
              <th style="padding: 0.7em; text-align: left; color: #222;">Headline</th>
              <th style="padding: 0.7em; text-align: left; color: #222;">Company</th>
              <th style="padding: 0.7em; text-align: left; color: #222;">Timestamp</th>
            </tr>
          </thead>
          <tbody id="viewerTable"></tbody>
        </table>
      </div>
      <div style="margin-top:2em;">
        <canvas id="trendChart" style="width:100%; max-width:600px; height:80px;"></canvas>
      </div>
    </section>
    <section style="margin-top: 3em;">
      <h3 style="font-size: 1.3em; font-weight: 600; margin-bottom: 1em; color:#222;">Live Logs</h3>
      <div class="log" id="logs" style="background: #fff; color: #222; border-radius: 12px; padding: 1.5em; font-size: 1em; border:1px solid #eee;"></div>
    </section>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
import { getStorage, ref, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

// Backend API base URL: use localhost for dev, Render for prod
const BACKEND_URL = (location.hostname === 'localhost') ? 'http://localhost:3000' : 'https://link-q2qi.onrender.com';

const firebaseConfig = {
  apiKey: "AIzaSyAPX-69qLt2Kwc_6rjMzymUUXhtPwSxsHk",
  authDomain: "linkrtdb.firebaseapp.com",
  projectId: "linkrtdb",
  storageBucket: "linkrtdb.appspot.com",
  messagingSenderId: "250414480081",
  appId: "1:250414480081:web:79de7428b63923578063f0",
  measurementId: "G-EZ2XERVTK7"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// Fetch daily totals and show table
async function fetchDailyTotals() {
  try {
    const q = query(collection(db, "daily_totals"), orderBy("date", "desc"), limit(30));
    const snapshot = await getDocs(q);
    let html = '<h4 style="margin-bottom:1em;color:#222;">Daily Totals</h4><table style="width:100%;border-collapse:collapse;background:#fff;margin-top:1em;border-radius:8px;overflow:hidden;">';
    html += '<thead style="background:#f8f8f8;"><tr><th style="padding:0.8em;text-align:left;">Date</th><th style="padding:0.8em;text-align:left;">Total Viewers</th></tr></thead><tbody>';
    if (snapshot.empty) {
      html += '<tr><td colspan="2" style="padding:1em;text-align:center;color:#888;">No daily totals yet. Use Test DB to add sample data.</td></tr>';
    } else {
      snapshot.forEach(doc => {
        const d = doc.data();
        html += `<tr><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.date}</td><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.total}</td></tr>`;
      });
    }
    html += '</tbody></table>';
    document.getElementById('dailyTotalsTable').innerHTML = html;
  } catch (error) {
    console.error('Error fetching daily totals:', error);
    document.getElementById('dailyTotalsTable').innerHTML = '<p>Error loading daily totals.</p>';
  }
}

// Fetch screenshots from Firebase Storage and show
async function fetchScreenshots() {
  try {
    const listRef = ref(storage, 'screenshots/');
    const res = await listAll(listRef);
    let html = '<div style="display:flex;flex-wrap:wrap;gap:1em;">';
    for (const itemRef of res.items) {
      const url = await getDownloadURL(itemRef);
      // Parse timestamp from filename (expecting format: YYYY-MM-DD_HH-MM-SS)
      const filename = itemRef.name.replace('profile-views-', '').replace('.png', '');
      const [datePart, timePart] = filename.split('_');
      const displayTime = datePart && timePart ? `${datePart} ${timePart.replace(/-/g, ':')} IST` : filename;
      html += `<div><img src="${url}" class="screenshot-img" onclick="openScreenshotPopup('${url}')" style="max-width:220px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:0.5em;cursor:pointer;"><div style="text-align:center;color:#222;font-size:0.9em;">${displayTime}</div></div>`;
    }
    html += '</div>';
    document.getElementById('screenshot-table').innerHTML = html;
  } catch (error) {
    console.error('Error fetching screenshots:', error);
    document.getElementById('screenshot-table').innerHTML = '<p>No screenshots available or error loading.</p>';
  }
}

// Fetch total viewers from latest daily total
async function fetchTotalViewers() {
  try {
    const q = query(collection(db, "daily_totals"), orderBy("date", "desc"), limit(1));
    const snapshot = await getDocs(q);
    let total = 0;
    snapshot.forEach(doc => { total = doc.data().total; });
    document.getElementById('total').textContent = total;
    
    // Also try to get from viewers collection if no daily totals
    if (total === 0) {
      const viewersQ = query(collection(db, "viewers"));
      const viewersSnapshot = await getDocs(viewersQ);
      document.getElementById('total').textContent = viewersSnapshot.size;
    }
  } catch (error) {
    console.error('Error fetching total viewers:', error);
    document.getElementById('total').textContent = '0';
  }
}

// Insert mock viewer data for testing Firestore connection
async function insertMockViewer() {
  const viewerCol = collection(db, "viewers");
  const mockViewer = {
    name: "Test User",
    headline: "Testing Headline",
    company: "Test Company",
    timestamp: new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" })
  };
  await addDoc(viewerCol, mockViewer);
}

// Fetch viewer details and show in table
async function fetchViewerDetails() {
  try {
    const q = query(collection(db, "viewers"), orderBy("timestamp", "desc"), limit(30));
    const snapshot = await getDocs(q);
    let html = "";
    if (snapshot.empty) {
      html = `<tr><td colspan="4" style="padding:1em;text-align:center;color:#888;">No viewer data yet. Use Test DB to add sample data or run the scraper.</td></tr>`;
    } else {
      snapshot.forEach(doc => {
        const d = doc.data();
        html += `<tr><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.name || 'N/A'}</td><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.headline || 'N/A'}</td><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.company || 'N/A'}</td><td style="padding:0.8em;border-bottom:1px solid #eee;">${d.timestamp || 'N/A'}</td></tr>`;
      });
    }
    // Add test element row for visual confirmation
    html += `<tr style='background:#ffe;'><td style="padding:0.8em;border-bottom:1px solid #eee;">Test Element</td><td style="padding:0.8em;border-bottom:1px solid #eee;">Test Headline</td><td style="padding:0.8em;border-bottom:1px solid #eee;">Test Company</td><td style="padding:0.8em;border-bottom:1px solid #eee;">${new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" })}</td></tr>`;
    document.getElementById('viewerTable').innerHTML = html;
  } catch (error) {
    console.error('Error fetching viewer details:', error);
    document.getElementById('viewerTable').innerHTML = `<tr><td colspan="4" style="padding:1em;text-align:center;color:#f44;">Error loading viewer data: ${error.message}</td></tr>`;
  }
}

// Insert mock daily total for testing
async function insertMockDailyTotal() {
  try {
    const dailyCol = collection(db, "daily_totals");
    const today = new Date().toLocaleDateString("en-IN", { timeZone: "Asia/Kolkata" });
    const randomTotal = Math.floor(Math.random()*100)+1;
    await addDoc(dailyCol, { date: today, total: randomTotal });
    console.log('Mock daily total added successfully');
  } catch (error) {
    console.error('Error adding mock daily total:', error);
  }
}

// Insert mock viewer data for testing Firestore connection
async function insertMockViewer() {
  try {
    const viewerCol = collection(db, "viewers");
    const mockViewer = {
      name: "Test User " + Math.floor(Math.random()*1000),
      headline: "Testing Headline",
      company: "Test Company",
      timestamp: new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" })
    };
    await addDoc(viewerCol, mockViewer);
    console.log('Mock viewer added successfully');
  } catch (error) {
    console.error('Error adding mock viewer:', error);
  }
}

// Status bar logic (removed duplicate, only in global script)

// Removed duplicate window functions (moved to global scope)

// Make functions globally accessible for button handlers
window.fetchTotalViewers = fetchTotalViewers;
window.fetchDailyTotals = fetchDailyTotals;
window.fetchScreenshots = fetchScreenshots;
window.fetchViewerDetails = fetchViewerDetails;
window.insertMockViewer = insertMockViewer;
window.insertMockDailyTotal = insertMockDailyTotal;

// Global functions for screenshot popup
window.openScreenshotPopup = function(url) {
  document.getElementById('popup-img').src = url;
  document.getElementById('screenshot-popup').style.display = 'flex';
};

window.closeScreenshotPopup = function() {
  document.getElementById('screenshot-popup').style.display = 'none';
};

// TEST: Insert mock data to check Firestore connection
window.testFirestore = async function() {
  try {
    document.getElementById('status-bar').textContent = 'Testing DB...';
    document.getElementById('status-bar').style.background = '#ff9800';
    
    await insertMockViewer();
    await insertMockDailyTotal();
    
    // Refresh all data
    await fetchViewerDetails();
    await fetchTotalViewers();
    await fetchDailyTotals();
    await fetchScreenshots();
    
    document.getElementById('status-bar').textContent = 'DB Test Complete';
    document.getElementById('status-bar').style.background = '#4caf50';
    
    setTimeout(() => {
      document.getElementById('status-bar').textContent = 'Idle';
      document.getElementById('status-bar').style.background = '#4f8cff';
    }, 3000);
  } catch (error) {
    console.error('Test failed:', error);
    document.getElementById('status-bar').textContent = 'DB Test Failed';
    document.getElementById('status-bar').style.background = '#ff4f4f';
  }
};

// Initial load
fetchTotalViewers();
fetchDailyTotals();
fetchScreenshots();
fetchViewerDetails();
  </script>
  <script>
function setStatusBar(status) {
  const bar = document.getElementById('status-bar');
  bar.textContent = status;
  bar.style.background = status === 'Scraping...' ? '#ff9800' : (status === 'Stopped' ? '#ff4f4f' : '#4f8cff');
}

async function launchScrape() {
  setStatusBar('Scraping...');
  document.getElementById('launchBtn').disabled = true;
  document.getElementById('launchBtn').textContent = 'Scraping...';
  
  try {
    const response = await fetch((location.hostname === 'localhost' ? 'http://localhost:3000' : 'https://link-q2qi.onrender.com') + '/api/scrape', { method: 'POST' });
    const result = await response.json();
    
    setStatusBar('Idle');
    document.getElementById('launchBtn').disabled = false;
    document.getElementById('launchBtn').textContent = 'Launch!!';
    
    // Refresh all data after scraping
    if (window.fetchTotalViewers) await window.fetchTotalViewers();
    if (window.fetchDailyTotals) await window.fetchDailyTotals();
    if (window.fetchScreenshots) await window.fetchScreenshots();
    if (window.fetchViewerDetails) await window.fetchViewerDetails();
  } catch (error) {
    console.error('Scrape failed:', error);
    setStatusBar('Scrape Failed');
    document.getElementById('launchBtn').disabled = false;
    document.getElementById('launchBtn').textContent = 'Launch!!';
  }
}

async function stopScrape() {
  setStatusBar('Stopped');
  try {
    await fetch((location.hostname === 'localhost' ? 'http://localhost:3000' : 'https://link-q2qi.onrender.com') + '/api/stop-scrape', { method: 'POST' });
  } catch (error) {
    console.error('Stop failed:', error);
  }
}

function testFirestore() {
  if (window.testFirestore) {
    window.testFirestore();
  } else {
    console.error('testFirestore function not available');
  }
}
  </script>
</body>
</html>