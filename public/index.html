<!DOCTYPE html>
<html>
<head>
  <title>LinkedIn Profile View Tracker</title>
  <style>
    body { font-family: sans-serif; background: #f6f6f6; margin: 0; padding: 2em; }
    .btn { background: #333; color: #fff; padding: 1em 2em; border: none; border-radius: 5px; cursor: pointer; }
    .log { font-family: monospace; margin-top: 2em; }
    .viewer { background: #fff; margin: 1em 0; padding: 1em; border-radius: 5px; }
    .screenshot-img { max-width:220px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08); cursor:pointer; transition:transform 0.2s; }
    .screenshot-img:hover { transform:scale(1.05); }
    #screenshot-popup {
      display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.8); z-index:9999;
      align-items:center; justify-content:center;
    }
    #screenshot-popup img { max-width:90vw; max-height:90vh; border-radius:16px; box-shadow:0 4px 32px rgba(0,0,0,0.2); }
    #screenshot-popup:active { display:none; }
  </style>
</head>
<body>
  <nav style="background: #fff; color: #222; padding: 1.5em 2em; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee;">
    <div style="font-size: 2em; font-weight: bold; letter-spacing: 1px;">Profile Analytics</div>
    <div id="status-bar" style="font-size:1.2em;color:#fff;background:#4f8cff;padding:0.5em 1.5em;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-right:2em;">Idle</div>
    <button class="btn" id="launchBtn" onclick="launchScrape()" style="background:#222;color:#fff;">Launch!!</button>
    <button class="btn" onclick="stopScrape()" style="background:#ff4f4f;color:#fff;margin-left:1em;">Stop</button>
  </nav>
  <div id="screenshot-popup" onclick="closeScreenshotPopup()"><img id="popup-img" src="" alt="Screenshot"></div>
  <main style="max-width: 1200px; margin: 3em auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 32px rgba(0,0,0,0.07); padding: 3em;">
    <section style="margin-bottom: 3em; display: flex; gap: 4em; justify-content: space-between;">
      <div style="flex:1;">
        <h2 style="font-size: 2em; font-weight: 700; margin-bottom: 1em; color:#222;">Total Viewers</h2>
        <div style="font-size: 3em; font-weight: bold, color: #222; background: #f8f8f8; border-radius: 12px; padding: 1em 2em; display:inline-block;"> <span id="total">0</span></div>
        <div id="last-updated" style="font-size:1em;color:#888;margin-top:0.5em;"></div>
      </div>
      <div style="flex:2;">
        <div id="dailyTotalsTable" style="margin-top:1em;"></div>
      </div>
    </section>
    <section style="margin-bottom: 3em;">
      <h3 style="font-size: 1.3em; font-weight: 600; margin-bottom: 1em; color:#222;">Recent Viewer Screenshots (OCR)</h3>
      <div id="screenshot-table" style="background:#fafafa; border-radius:12px; padding:1em;"></div>
    </section>
    <section style="margin-bottom: 3em;">
      <h3 style="font-size: 1.3em; font-weight: 600; margin-bottom: 1em; color:#222;">Viewer Details</h3>
      <div style="background:#fafafa; border-radius:12px; padding:2em;">
        <table style="width: 100%; border-collapse: collapse; background: #fff;">
          <thead style="background: #f6f6f6;">
            <tr>
              <th style="padding: 0.7em; text-align: left; color: #222;">Name</th>
              <th style="padding: 0.7em; text-align: left; color: #222;">Headline</th>
              <th style="padding: 0.7em; text-align: left; color: #222;">Company</th>
              <th style="padding: 0.7em; text-align: left; color: #222;">Timestamp</th>
            </tr>
          </thead>
          <tbody id="viewerTable"></tbody>
        </table>
      </div>
      <div style="margin-top:2em;">
        <canvas id="trendChart" style="width:100%; max-width:600px; height:80px;"></canvas>
      </div>
    </section>
    <section style="margin-top: 3em;">
      <h3 style="font-size: 1.3em; font-weight: 600; margin-bottom: 1em; color:#222;">Live Logs</h3>
      <div class="log" id="logs" style="background: #fff; color: #222; border-radius: 12px; padding: 1.5em; font-size: 1em; border:1px solid #eee;"></div>
    </section>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">

// Backend API base URL: use localhost for dev, Render for prod
const BACKEND_URL = (location.hostname === 'localhost') ? 'http://localhost:3000' : 'https://link-q2qi.onrender.com';

const firebaseConfig = {
  apiKey: "AIzaSyAPX-69qLt2Kwc_6rjMzymUUXhtPwSxsHk",
  authDomain: "linkrtdb.firebaseapp.com",
  projectId: "linkrtdb",
  storageBucket: "linkrtdb.appspot.com",
  messagingSenderId: "250414480081",
  appId: "1:250414480081:web:79de7428b63923578063f0",
  measurementId: "G-EZ2XERVTK7"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// Fetch daily totals and show table
async function fetchDailyTotals() {
  const q = query(collection(db, "daily_totals"), orderBy("date", "desc"), limit(30));
  const snapshot = await getDocs(q);
  let html = '<table style="width:100%;border-collapse:collapse;background:#fff;margin-top:1em;">';
  html += '<tr><th>Date</th><th>Total Viewers</th></tr>';
  snapshot.forEach(doc => {
    const d = doc.data();
    html += `<tr><td>${d.date}</td><td>${d.total}</td></tr>`;
  });
  html += '</table>';
  document.getElementById('dailyTotalsTable').innerHTML = html;
}

// Fetch screenshots from Firebase Storage and show
async function fetchScreenshots() {
  const listRef = ref(storage, 'screenshots/');
  const res = await listAll(listRef);
  let html = '<div style="display:flex;flex-wrap:wrap;gap:1em;">';
  for (const itemRef of res.items) {
    const url = await getDownloadURL(itemRef);
    // Parse timestamp from filename
    const ts = itemRef.name.replace('profile-views-', '').replace('.png', '').replace(/-/g, '/');
    html += `<div><img src="${url}" style="max-width:220px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:0.5em;"><div style="text-align:center;color:#222;font-size:0.9em;">${ts} IST</div></div>`;
  }
  html += '</div>';
  document.getElementById('screenshot-table').innerHTML = html;
}

// Fetch total viewers from latest daily total
async function fetchTotalViewers() {
  const q = query(collection(db, "daily_totals"), orderBy("date", "desc"), limit(1));
  const snapshot = await getDocs(q);
  let total = 0;
  snapshot.forEach(doc => { total = doc.data().total; });
  document.getElementById('total').textContent = total;
}

// Status bar logic
function setStatusBar(status) {
  const bar = document.getElementById('status-bar');
  bar.textContent = status;
  bar.style.background = status === 'Scraping...' ? '#ff9800' : (status === 'Stopped' ? '#ff4f4f' : '#4f8cff');
}

window.launchScrape = async function() {
  setStatusBar('Scraping...');
  document.getElementById('launchBtn').disabled = true;
  document.getElementById('launchBtn').textContent = 'Scraping...';
  await fetch(`${BACKEND_URL}/api/scrape`, { method: 'POST' });
  setStatusBar('Idle');
  document.getElementById('launchBtn').disabled = false;
  document.getElementById('launchBtn').textContent = 'Launch!!';
  fetchTotalViewers();
  fetchDailyTotals();
  fetchScreenshots();
};
window.stopScrape = async function() {
  setStatusBar('Stopped');
  await fetch(`${BACKEND_URL}/api/stop-scrape`, { method: 'POST' });
};

// Initial load
fetchTotalViewers();
fetchDailyTotals();
fetchScreenshots();
  </script>
</body>
</html>